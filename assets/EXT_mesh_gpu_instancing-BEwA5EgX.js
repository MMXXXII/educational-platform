import{ba as r,V as y,a4 as T,a8 as F}from"./sceneFragmentDeclaration-CNWtVIbJ.js";import{G as b,A as V}from"./glTFLoader-BlBnIl-i.js";import{u as E,r as M}from"./model-viewer-CRf71ZHW.js";import"./objectModelMapping-DZbRXB0J.js";import"./with-props-CdbLO-WJ.js";import"./chunk-AYJ5UCUI-B1579ApN.js";import"./waterMaterial-DHEJP-Do.js";const n="EXT_mesh_gpu_instancing";class g{constructor(i){this.name=n,this._loader=i,this.enabled=this._loader.isExtensionUsed(n)}dispose(){this._loader=null}loadNodeAsync(i,o,f){return b.LoadExtensionAsync(i,o,this.name,(u,h)=>{this._loader._disableInstancedMesh++;const d=this._loader.loadNodeAsync(`/nodes/${o.index}`,o,f);if(this._loader._disableInstancedMesh--,!o._primitiveBabylonMeshes)return d;const c=new Array;let t=0;const l=a=>{if(h.attributes[a]==null){c.push(Promise.resolve(null));return}const s=V.Get(`${u}/attributes/${a}`,this._loader.gltf.accessors,h.attributes[a]);if(c.push(this._loader._loadFloatAccessorAsync(`/accessors/${s.bufferView}`,s)),t===0)t=s.count;else if(t!==s.count)throw new Error(`${u}/attributes: Instance buffer accessors do not have the same count.`)};return l("TRANSLATION"),l("ROTATION"),l("SCALE"),d.then(a=>Promise.all(c).then(([s,p,A])=>{const _=new Float32Array(t*16);r.Vector3[0].copyFromFloats(0,0,0),r.Quaternion[0].copyFromFloats(0,0,0,1),r.Vector3[1].copyFromFloats(1,1,1);for(let e=0;e<t;++e)s&&y.FromArrayToRef(s,e*3,r.Vector3[0]),p&&T.FromArrayToRef(p,e*4,r.Quaternion[0]),A&&y.FromArrayToRef(A,e*3,r.Vector3[1]),F.ComposeToRef(r.Vector3[1],r.Quaternion[0],r.Vector3[0],r.Matrix[0]),r.Matrix[0].copyToArray(_,e*16);for(const e of o._primitiveBabylonMeshes)e.thinInstanceSetBuffer("matrix",_,16,!0);return a}))})}}E(n);M(n,!0,m=>new g(m));export{g as EXT_mesh_gpu_instancing};
