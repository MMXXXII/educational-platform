import{c as g,bh as y,Q as f,a4 as m,a8 as b,bi as x,ag as A}from"./sceneFragmentDeclaration-CNWtVIbJ.js";import{G as T,A as h}from"./glTFLoader-BlBnIl-i.js";import{u as w,r as S}from"./model-viewer-CRf71ZHW.js";import"./objectModelMapping-DZbRXB0J.js";import"./with-props-CdbLO-WJ.js";import"./chunk-AYJ5UCUI-B1579ApN.js";import"./waterMaterial-DHEJP-Do.js";class u extends g{constructor(t,e,n,r=5,a=0,s=!1,i=!1,l=3,o=null){super("",t),this._texture=t.getEngine().createRawCubeTexture(e,n,r,a,s,i,l,o)}update(t,e,n,r,a=null){this._texture.getEngine().updateRawCubeTexture(this._texture,t,e,n,r,a)}updateRGBDAsync(t,e=null,n=.8,r=0){return y(this._texture,t,e,n,r).then(()=>{})}clone(){return f.Clone(()=>{const t=this.getScene(),e=this._texture,n=new u(t,e._bufferViewArray,e.width,e.format,e.type,e.generateMipMaps,e.invertY,e.samplingMode,e._compression);return e.source===13&&n.updateRGBDAsync(e._bufferViewArrayArray,e._sphericalPolynomial,e._lodGenerationScale,e._lodGenerationOffset),n},this)}}const c="EXT_lights_image_based";class G{constructor(t){this.name=c,this._loader=t,this.enabled=this._loader.isExtensionUsed(c)}dispose(){this._loader=null,delete this._lights}onLoading(){const t=this._loader.gltf.extensions;if(t&&t[this.name]){const e=t[this.name];this._lights=e.lights}}loadSceneAsync(t,e){return T.LoadExtensionAsync(t,e,this.name,(n,r)=>{this._loader._allMaterialsDirtyRequired=!0;const a=new Array;a.push(this._loader.loadSceneAsync(t,e)),this._loader.logOpen(`${n}`);const s=h.Get(`${n}/light`,this._lights,r.light);return a.push(this._loadLightAsync(`/extensions/${this.name}/lights/${r.light}`,s).then(i=>{this._loader.babylonScene.environmentTexture=i})),this._loader.logClose(),Promise.all(a).then(()=>{})})}_loadLightAsync(t,e){if(!e._loaded){const n=new Array;this._loader.logOpen(`${t}`);const r=new Array(e.specularImages.length);for(let a=0;a<e.specularImages.length;a++){const s=e.specularImages[a];r[a]=new Array(s.length);for(let i=0;i<s.length;i++){const l=`${t}/specularImages/${a}/${i}`;this._loader.logOpen(`${l}`);const o=s[i],_=h.Get(l,this._loader.gltf.images,o);n.push(this._loader.loadImageAsync(`/images/${o}`,_).then(p=>{r[a][i]=p})),this._loader.logClose()}}this._loader.logClose(),e._loaded=Promise.all(n).then(()=>{const a=new u(this._loader.babylonScene,null,e.specularImageSize);if(a.name=e.name||"environment",e._babylonTexture=a,e.intensity!=null&&(a.level=e.intensity),e.rotation){let o=m.FromArray(e.rotation);this._loader.babylonScene.useRightHandedSystem||(o=m.Inverse(o)),b.FromQuaternionToRef(o,a.getReflectionTextureMatrix())}if(!e.irradianceCoefficients)throw new Error(`${t}: Irradiance coefficients are missing`);const s=x.FromArray(e.irradianceCoefficients);s.scaleInPlace(e.intensity),s.convertIrradianceToLambertianRadiance();const i=A.FromHarmonics(s),l=(r.length-1)/Math.log2(e.specularImageSize);return a.updateRGBDAsync(r,i,l)})}return e._loaded.then(()=>e._babylonTexture)}}w(c);S(c,!0,d=>new G(d));export{G as EXT_lights_image_based};
