import{w as j}from"./with-props-CdbLO-WJ.js";import{a as o,x as N,o as e}from"./chunk-AYJ5UCUI-B1579ApN.js";import{E as d}from"./EditorPanel-ByBmPvH_.js";import{f as E,e as k}from"./indexedDB-DhaisdTJ.js";import{F as I}from"./ArrowLeftIcon-DK87n-Vp.js";import{F as C}from"./CheckIcon-7azco_cl.js";import"./sceneFragmentDeclaration-CNWtVIbJ.js";import"./waterMaterial-DHEJP-Do.js";const D=()=>{const[r,g]=o.useState(null),[f,l]=o.useState(!1),[h,b]=o.useState(null),[i,c]=o.useState(!0),n=N(),m=o.useRef(!1);o.useEffect(()=>{let t=localStorage.getItem("currentEditingLesson")||localStorage.getItem("editCurrentEditingLesson");if(!t){n(-1);return}try{const s=JSON.parse(t);if(g(s),s.lesson&&s.lesson.scene_data)try{let a=s.lesson.scene_data;typeof a=="string"&&(a=JSON.parse(a)),b(a)}catch(a){console.error("Error parsing existing scene data:",a)}}catch(s){console.error("Error parsing lesson data:",s),n(-1);return}c(!1)},[n]);const w=async()=>{if(!m.current)try{c(!0);let t=null;if(window.currentSceneInstance&&window.currentSceneInstance.serializeScene?t=window.currentSceneInstance.serializeScene():typeof d.exportScene=="function"&&(t=d.exportScene()),t!==void 0){const s=t||{version:"1.0",timestamp:Date.now(),models:[]};if(!r)throw new Error("Missing lesson data for scene save");const a=r.lessonIndex,x=r.isEditMode?"edit":"create",u=r.courseId;console.log(`Saving scene data for lesson index ${a}, mode: ${x}, courseId: ${u}`),await E(s,a,x,u)?console.log("Scene data successfully saved to IndexedDB"):(localStorage.setItem("savedSceneData",JSON.stringify(s)),console.warn("Fallback: Scene data saved to localStorage")),await new Promise(S=>setTimeout(S,150)),m.current=!0,r&&r.isEditMode&&r.courseId?n(`/edit-course/${r.courseId}`):n("/create-course")}else throw new Error("Could not access scene data from EditorPanel")}catch(t){console.error("Error saving scene:",t),alert("Ошибка при сохранении сцены. Пожалуйста, попробуйте еще раз.")}finally{c(!1)}},y=()=>{l(!0)},p=async()=>{const t=(r==null?void 0:r.lessonIndex)||null,s=r!=null&&r.isEditMode?"edit":"create",a=(r==null?void 0:r.courseId)||null;await k(t,s,a),localStorage.removeItem("savedSceneData"),r&&r.isEditMode&&r.courseId?n(`/edit-course/${r.courseId}`):n("/create-course")},v=()=>{l(!1)};return i&&!r?e.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-gray-100 dark:bg-gray-900",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-300",children:"Загрузка редактора..."})]})}):e.jsxs("div",{className:"fixed inset-0 flex flex-col overflow-hidden bg-white dark:bg-gray-900",children:[e.jsx("header",{className:"bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-3 shadow-sm z-10 flex-shrink-0",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center min-w-0 flex-1",children:[e.jsx("button",{onClick:y,className:"mr-4 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 flex-shrink-0",disabled:i,children:e.jsx(I,{className:"h-5 w-5 text-gray-600 dark:text-gray-300"})}),e.jsx("h1",{className:"font-bold text-xl truncate text-gray-800 dark:text-white",children:r?`Создание сцены для урока: ${r.lesson.title||"Новый урок"}`:"Редактор сцены"})]}),e.jsx("button",{onClick:w,disabled:i,className:`px-4 py-2 rounded-md flex items-center flex-shrink-0 ml-4 ${i?"bg-gray-400 dark:bg-gray-600 cursor-not-allowed":"bg-green-600 hover:bg-green-700"} text-white`,children:i?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Сохранение..."]}):e.jsxs(e.Fragment,{children:[e.jsx(C,{className:"h-5 w-5 mr-1"}),"Сохранить и вернуться"]})})]})}),e.jsx("div",{className:"flex flex-col w-full h-screen overflow-hidden",children:e.jsx(d,{initialSceneData:h,className:"w-full h-full"})}),f&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md mx-auto m-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-800 dark:text-white mb-4",children:"Выйти без сохранения?"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-300 mb-6",children:"Все несохраненные изменения будут потеряны. Вы уверены, что хотите выйти?"}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx("button",{onClick:v,className:"px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700",children:"Отмена"}),e.jsx("button",{onClick:p,className:"px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700",children:"Выйти без сохранения"})]})]})})]})};function J({}){return[{title:"Редактор"},{name:"description",content:"Создавайте свои карты"}]}const O=j(function(){return e.jsx(D,{})});export{O as default,J as meta};
