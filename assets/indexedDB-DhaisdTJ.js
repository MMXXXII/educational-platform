const g="CourseEditorDB";const n="courseData",p=()=>"indexedDB"in window,D=()=>new Promise((t,o)=>{const e=indexedDB.open(g,1);e.onerror=()=>o(e.error),e.onsuccess=()=>t(e.result),e.onupgradeneeded=a=>{const r=a.target.result;r.objectStoreNames.contains(n)||r.createObjectStore(n,{keyPath:"id"})}}),f=async(t,o,e="create",a=null)=>{if(!p())return console.warn("IndexedDB not supported, data will not be saved"),!1;try{const l=(await D()).transaction([n],"readwrite").objectStore(n),c={id:e==="create"?"courseFormBackup":`editCourseFormBackup_${a}`,courseData:t,image:o,timestamp:Date.now(),mode:e,courseId:a};return await l.put(c),!0}catch(r){return console.error("Error saving to IndexedDB:",r),!1}},y=async(t="create",o=null)=>{try{const r=(await D()).transaction([n],"readonly").objectStore(n),s=t==="create"?"courseFormBackup":`editCourseFormBackup_${o}`;return new Promise((l,d)=>{const c=r.get(s);c.onsuccess=()=>{const i=c.result;l(i?{courseData:i.courseData,image:i.image,timestamp:i.timestamp}:null)},c.onerror=()=>d(c.error)})}catch(e){return console.error("Error loading from IndexedDB:",e),null}},b=async(t,o=null,e="create",a=null)=>{if(!p())return console.warn("IndexedDB not supported, scene data will not be saved"),!1;try{const l=(await D()).transaction([n],"readwrite").objectStore(n),c={id:e==="create"?`sceneData${o!==null?`_lesson_${o}`:""}`:`editSceneData_${a}${o!==null?`_lesson_${o}`:""}`,sceneData:t,lessonIndex:o,mode:e,courseId:a,timestamp:Date.now()};return await l.put(c),!0}catch(r){return console.error("Error saving scene data to IndexedDB:",r),!1}},w=async(t=null,o="create",e=null)=>{if(!p())return null;try{const s=(await D()).transaction([n],"readonly").objectStore(n),l=o==="create"?`sceneData${t!==null?`_lesson_${t}`:""}`:`editSceneData_${e}${t!==null?`_lesson_${t}`:""}`;return new Promise((d,c)=>{const i=s.get(l);i.onsuccess=()=>{const u=i.result;d(u?{sceneData:u.sceneData,lessonIndex:u.lessonIndex,timestamp:u.timestamp}:null)},i.onerror=()=>c(i.error)})}catch(a){return console.error("Error loading scene data from IndexedDB:",a),null}},B=async(t=null,o="create",e=null)=>{try{const s=(await D()).transaction([n],"readwrite").objectStore(n),l=o==="create"?`sceneData${t!==null?`_lesson_${t}`:""}`:`editSceneData_${e}${t!==null?`_lesson_${t}`:""}`;return await s.delete(l),!0}catch(a){return console.error("Error deleting scene data from IndexedDB:",a),!1}},k=async(t=null,o="create",e=null)=>{try{const a=await w(t,o,e);if(a)return a.sceneData;try{const r=localStorage.getItem("savedSceneData");if(r){const s=JSON.parse(r);return await b(s,t,o,e),localStorage.removeItem("savedSceneData"),s}}catch(r){console.error("Error reading from localStorage during fallback:",r)}return null}catch(a){console.error("Error in loadSceneDataWithFallback:",a);try{const r=localStorage.getItem("savedSceneData");if(r)return JSON.parse(r)}catch(r){console.error("Error in localStorage fallback:",r)}return null}},_=async(t="create",o=null)=>{try{const r=(await D()).transaction([n],"readwrite").objectStore(n);return new Promise((s,l)=>{const d=r.openCursor();d.onsuccess=c=>{const i=c.target.result;if(i){const u=i.value;(u.id.startsWith("sceneData")||u.id.startsWith("editSceneData"))&&u.mode===t&&(t==="create"||u.courseId===o)&&i.delete(),i.continue()}else localStorage.removeItem("savedSceneData"),s()},d.onerror=()=>l(d.error)})}catch(e){console.error("Error cleaning up scene data:",e),localStorage.removeItem("savedSceneData")}},h=async(t="create",o=null)=>{try{const r=(await D()).transaction([n],"readwrite").objectStore(n),s=t==="create"?"courseFormBackup":`editCourseFormBackup_${o}`;return await r.delete(s),!0}catch(e){return console.error("Error deleting from IndexedDB:",e),!1}},E=async()=>{try{const e=(await D()).transaction([n],"readwrite").objectStore(n),a=Date.now()-24*60*60*1e3;return new Promise((r,s)=>{const l=e.openCursor();l.onsuccess=d=>{const c=d.target.result;c?(c.value.timestamp<a&&c.delete(),c.continue()):(["savedSceneData","allLessonsBackup","currentEditingLesson","editAllLessonsBackup","editCurrentEditingLesson"].forEach(u=>{const m=localStorage.getItem(u);if(m)try{const S=JSON.parse(m);S.timestamp&&S.timestamp<a&&localStorage.removeItem(u)}catch{localStorage.removeItem(u)}}),r())},l.onerror=()=>s(l.error)})}catch(t){console.error("Error cleaning up IndexedDB:",t)}};export{_ as a,k as b,E as c,h as d,B as e,b as f,y as l,f as s};
