import{a as i,x as A,o as _}from"./chunk-AYJ5UCUI-B1579ApN.js";import{a as w,c as m}from"./config-GGwLlXRi.js";import{c as U}from"./indexedDB-DhaisdTJ.js";const g=(e,r)=>{localStorage.setItem("access_token",e),localStorage.setItem("refresh_token",r)},l=()=>localStorage.getItem("access_token"),p=()=>{localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token")},s=w.create({baseURL:m.apiUrl,headers:{"Content-Type":"application/json"},withCredentials:!0});s.interceptors.request.use(e=>{const r=l();return r&&(e.headers.Authorization=`Bearer ${r}`),e},e=>Promise.reject(e));s.interceptors.response.use(e=>e,async e=>{if(!e.response)return console.error("Network error:",e),Promise.reject(e);const r=e.config;if(e.response.status===401&&!r._retry){r._retry=!0;try{const t=await w.post(`${m.apiUrl}/api/refresh`,{},{headers:{Authorization:`Bearer ${l()}`},withCredentials:!0}),{access_token:n,refresh_token:u}=t.data;return g(n,u),r.headers.Authorization=`Bearer ${n}`,s(r)}catch(t){return p(),window.location.href="/sign-in",Promise.reject(t)}}return Promise.reject(e)});const v={login:async(e,r)=>{const t=new URLSearchParams;return t.append("username_or_email",e),t.append("password",r),(await s.post("/custom-token",t,{headers:{"Content-Type":"application/x-www-form-urlencoded"}})).data},refresh:async()=>(await s.post("/refresh",{})).data,loginWithVK:async()=>(await s.get("/login/vk")).data,handleVKCallback:async e=>(await s.get("/vk-callback",{params:{code:e}})).data},h={getCurrentUser:async()=>(await s.get("/users/me")).data,createUser:async e=>{const r=new URLSearchParams;return r.append("username",e.username),r.append("email",e.email),r.append("password",e.password),r.append("role",e.role||"user"),(await s.post("/users",r,{headers:{"Content-Type":"application/x-www-form-urlencoded"}})).data},getAllUsers:async()=>(await s.get("/users")).data,updatePassword:async(e,r)=>(await s.put("/users/me/password",{current_password:e,new_password:r})).data,updateUser:async(e,r)=>(await s.put(`/users/${e}`,r)).data,deleteUser:async e=>{await s.delete(`/users/${e}`)},getUserById:async e=>(await s.get(`/users/${e}`)).data},f=i.createContext(null);function L({children:e}){const[r,t]=i.useState(null),[n,u]=i.useState(!0),y=A();i.useEffect(()=>{(async()=>{try{if(l()){const o=await h.getCurrentUser();t(o)}}catch(o){console.error("Error initializing auth:",o),p()}finally{u(!1)}})()},[]);const k={user:r,isAuthenticated:!!r,isLoading:n,login:async(a,o)=>{try{const c=await v.login(a,o);g(c.access_token,c.refresh_token);const d=await h.getCurrentUser();return t({...d}),d}catch(c){throw console.error("Login error:",c),c}},logout:async()=>{try{p(),t(null),await U(),y("/")}catch(a){console.error("Logout error:",a)}},hasRole:a=>r?Array.isArray(a)?a.includes(r.role):r.role===a:!1};return _.jsx(f.Provider,{value:k,children:e})}const R=()=>{const e=i.useContext(f);if(!e)throw new Error("useAuth must be used within an AuthProvider");return e};export{L as A,h as a,s as b,R as u};
