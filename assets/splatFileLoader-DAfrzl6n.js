import{h as q,bd as H,be as N,bf as z,bg as F,aU as L,L as X,V as Z,X as $,R as J}from"./sceneFragmentDeclaration-CNWtVIbJ.js";import{S as D}from"./model-viewer-CRf71ZHW.js";import"./with-props-CdbLO-WJ.js";import"./chunk-AYJ5UCUI-B1579ApN.js";import"./waterMaterial-DHEJP-Do.js";var E;(function(V){V[V.Splat=0]="Splat",V[V.PointCloud=1]="PointCloud",V[V.Mesh=2]="Mesh",V[V.Reject=3]="Reject"})(E||(E={}));class I{constructor(c=I._DefaultLoadingOptions){this.name=D.name,this._assetContainer=null,this.extensions=D.extensions,this._loadingOptions=c}createPlugin(c){return new I(c[D.name])}async importMeshAsync(c,r,t,l,n,f){return this._parseAsync(c,r,t,l).then(y=>({meshes:y,particleSystems:[],skeletons:[],animationGroups:[],transformNodes:[],geometries:[],lights:[],spriteManagers:[]}))}static _BuildPointCloud(c,r){if(!r.byteLength)return!1;const t=new Uint8Array(r),l=new Float32Array(r),n=3*4+3*4+4+4,f=t.length/n,y=function(x,u){const s=l[8*u+0],o=l[8*u+1],p=l[8*u+2];x.position=new Z(s,o,p);const w=t[n*u+24+0]/255,g=t[n*u+24+1]/255,a=t[n*u+24+2]/255;x.color=new $(w,g,a,1)};return c.addPoints(f,y),!0}static _BuildMesh(c,r){const t=new q("PLYMesh",c),l=new Uint8Array(r.data),n=new Float32Array(r.data),f=3*4+3*4+4+4,y=l.length/f,x=[],u=new H;for(let s=0;s<y;s++){const o=n[8*s+0],p=n[8*s+1],w=n[8*s+2];x.push(o,p,w)}if(r.hasVertexColors){const s=new Float32Array(y*4);for(let o=0;o<y;o++){const p=l[f*o+24+0]/255,w=l[f*o+24+1]/255,g=l[f*o+24+2]/255;s[o*4+0]=p,s[o*4+1]=w,s[o*4+2]=g,s[o*4+3]=1}u.colors=s}return u.positions=x,u.indices=r.faces,u.applyToMesh(t),t}_parseSPZAsync(c,r){const t=new Uint8Array(c),l=new Uint32Array(c.slice(0,12)),n=l[2],f=t[12],y=t[13];if(t[15]||l[0]!=1347635022||l[1]!=2)return new Promise(e=>{e({mode:3,data:s,hasVertexColors:!1})});const u=3*4+3*4+4+4,s=new ArrayBuffer(u*n),o=1/(1<<y),p=new Int32Array(1),w=new Uint8Array(p.buffer),g=function(e,h){return w[0]=e[h+0],w[1]=e[h+1],w[2]=e[h+2],w[3]=e[h+2]&128?255:0,p[0]*o};let a=16;const k=new Float32Array(s),M=new Float32Array(s),B=new Uint8ClampedArray(s),v=new Uint8ClampedArray(s);let i=1,d=0;this._loadingOptions.flipY||(i=-1,d=255);for(let e=0;e<n;e++)k[e*8+0]=g(t,a+0),k[e*8+1]=i*g(t,a+3),k[e*8+2]=i*g(t,a+6),a+=9;const b=.282;for(let e=0;e<n;e++){for(let h=0;h<3;h++){const S=(t[a+n+e*3+h]-127.5)/(.15*255);B[e*32+24+h]=N.Clamp((.5+b*S)*255,0,255)}B[e*32+24+3]=t[a+e]}a+=n*4;for(let e=0;e<n;e++)M[e*8+3+0]=Math.exp(t[a+0]/16-10),M[e*8+3+1]=Math.exp(t[a+1]/16-10),M[e*8+3+2]=Math.exp(t[a+2]/16-10),a+=3;for(let e=0;e<n;e++){const h=t[a+0],A=t[a+1]*i+d,S=t[a+2]*i+d,P=h/127.5-1,O=A/127.5-1,U=S/127.5-1;v[e*32+28+1]=h,v[e*32+28+2]=A,v[e*32+28+3]=S;const m=1-(P*P+O*O+U*U);v[e*32+28+0]=127.5+Math.sqrt(m<0?0:m)*127.5,a+=3}if(f){const h=((f+1)*(f+1)-1)*3,A=Math.ceil(h/16);let S=a;const P=[],U=r.getEngine().getCaps().maxTextureSize,m=Math.ceil(n/U);for(let C=0;C<A;C++){const _=new Uint8Array(m*U*4*4);P.push(_)}for(let C=0;C<n;C++)for(let _=0;_<h;_++){const R=t[S++],T=Math.floor(_/16),W=P[T],G=_%16,j=C*16;W[G+j]=R}return new Promise(C=>{C({mode:0,data:s,hasVertexColors:!1,sh:P})})}return new Promise(e=>{e({mode:0,data:s,hasVertexColors:!1})})}_parseAsync(c,r,t,l){const n=[],f=new ReadableStream({start(u){u.enqueue(new Uint8Array(t)),u.close()}}),y=new DecompressionStream("gzip"),x=f.pipeThrough(y);return new Promise(u=>{new Response(x).arrayBuffer().then(s=>{this._parseSPZAsync(s,r).then(o=>{r._blockEntityCollection=!!this._assetContainer;const p=new z("GaussianSplatting",null,r,this._loadingOptions.keepInRam);p._parentContainer=this._assetContainer,n.push(p),p.updateData(o.data,o.sh),r._blockEntityCollection=!1,u(n)})}).catch(()=>{I._ConvertPLYToSplat(t).then(async s=>{switch(r._blockEntityCollection=!!this._assetContainer,s.mode){case 0:{const o=new z("GaussianSplatting",null,r,this._loadingOptions.keepInRam);o._parentContainer=this._assetContainer,n.push(o),o.updateData(s.data,s.sh)}break;case 1:{const o=new F("PointCloud",1,r);I._BuildPointCloud(o,s.data)?await o.buildMeshAsync().then(p=>{n.push(p)}):o.dispose()}break;case 2:if(s.faces)n.push(I._BuildMesh(r,s));else throw new Error("PLY mesh doesn't contain face informations.");break;default:throw new Error("Unsupported Splat mode")}r._blockEntityCollection=!1,u(n)})})})}loadAssetContainerAsync(c,r,t){const l=new L(c);return this._assetContainer=l,this.importMeshAsync(null,c,r,t).then(n=>{for(const f of n.meshes)l.meshes.push(f);return this._assetContainer=null,l}).catch(n=>{throw this._assetContainer=null,n})}loadAsync(c,r,t){return this.importMeshAsync(null,c,r,t).then(()=>{})}static _ConvertPLYToSplat(c){const r=new Uint8Array(c),t=new TextDecoder().decode(r.slice(0,1024*10)),l=`end_header
`,n=t.indexOf(l);if(n<0||!t)return new Promise(i=>{i({mode:0,data:c})});const f=parseInt(/element vertex (\d+)\n/.exec(t)[1]),y=/element face (\d+)\n/.exec(t);let x=0;y&&(x=parseInt(y[1]));const u=/element chunk (\d+)\n/.exec(t);let s=0;u&&(s=parseInt(u[1]));let o=0,p=0;const w={double:8,int:4,uint:4,float:4,short:2,ushort:2,uchar:1,list:0};let g;(function(i){i[i.Vertex=0]="Vertex",i[i.Chunk=1]="Chunk",i[i.SH=2]="SH"})(g||(g={}));let a=1;const k=[],M=t.slice(0,n).split(`
`);for(const i of M)if(i.startsWith("property ")){const[,d,b]=i.split(" ");a==1?p+=w[d]:a==0?(k.push({name:b,type:d,offset:o}),o+=w[d]):a==2&&k.push({name:b,type:d,offset:o}),w[d]||X.Warn(`Unsupported property type: ${d}.`)}else if(i.startsWith("element ")){const[,d]=i.split(" ");d=="chunk"?a=1:d=="vertex"?a=0:d=="sh"&&(a=2)}const B=o,v=p;return z.ConvertPLYWithSHToSplatAsync(c).then(async i=>{const d=new DataView(c,n+l.length);let b=v*s+B*f;const e=[];if(x)for(let m=0;m<x;m++){const C=d.getUint8(b);if(C==3){b+=1;for(let _=0;_<C;_++){const R=d.getUint32(b+(2-_)*4,!0);e.push(R)}b+=12}}if(s)return new Promise(m=>{m({mode:0,data:i.buffer,sh:i.sh,faces:e,hasVertexColors:!1})});let h=0,A=0;const S=["x","y","z","scale_0","scale_1","scale_2","opacity","rot_0","rot_1","rot_2","rot_3"],P=["red","green","blue","f_dc_0","f_dc_1","f_dc_2"];for(let m=0;m<k.length;m++){const C=k[m];S.includes(C.name)&&h++,P.includes(C.name)&&A++}const O=h==S.length&&A==3,U=x?2:O?0:1;return new Promise(m=>{m({mode:U,data:i.buffer,sh:i.sh,faces:e,hasVertexColors:!!A})})})}}I._DefaultLoadingOptions={keepInRam:!1,flipY:!1};J(new I);export{I as SPLATFileLoader};
