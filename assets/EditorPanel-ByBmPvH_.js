import{a as u,o as i}from"./chunk-AYJ5UCUI-B1579ApN.js";import{E as ye,S as we,A as be,V as y,H as ke,D as ve,d as Ce,U as Me,M as g,P as H,C as o,b as x,e as A,f as X}from"./sceneFragmentDeclaration-CNWtVIbJ.js";import{G as Ne}from"./waterMaterial-DHEJP-Do.js";const b=20,l=1,R="level_editor_";let k=null;function W({initialSceneData:B=null}){const[P,Z]=u.useState("cube"),D=u.useRef("cube"),[F,Se]=u.useState([{id:"cube",type:"primitive",name:"Куб"},{id:"sphere",type:"primitive",name:"Сфера"},{id:"cylinder",type:"primitive",name:"Цилиндр"},{id:"player",type:"special",name:"Игрок"},{id:"exit",type:"special",name:"Выход"}]),[G,q]=u.useState([]),[M,L]=u.useState(""),[O,U]=u.useState(null),[N,I]=u.useState("place"),E=u.useRef(null),Y=u.useRef(null),s=u.useRef(null),K=u.useRef(null),v=u.useRef(null),S=u.useRef("place"),h=u.useRef(null);u.useRef(null);const Q=u.useRef(null),d=u.useRef(null),f=(r,e="info")=>{U({message:r,type:e}),setTimeout(()=>U(null),3e3)};u.useEffect(()=>{if(!E.current)return;const r=new ye(E.current,!0,{preserveDrawingBuffer:!0,stencil:!0});Y.current=r;const e=new we(r);s.current=e,k={scene:e,serializeScene:$,clearScene:T},typeof window<"u"&&(window.currentSceneInstance=k);const t=new be("camera",-Math.PI/2,Math.PI/3,20,new y(b/2,0,b/2),e);t.attachControl(E.current,!0),t.lowerRadiusLimit=5,t.upperRadiusLimit=40,t.setTarget(new y(0,0,0));const n=new ke("light",new y(0,1,0),e);n.intensity=.7;const a=new ve("dirLight",new y(-1,-2,-1),e);a.position=new y(b,10,b),a.intensity=.5,ee(e);const c=new Ce("highlightLayer",e);h.current=c;const p=new Me(e);Q.current=p,re(e);const w=g.CreateGround("positioningPlane",{width:b,height:b},e);if(w.visibility=0,w.isPickable=!0,e.onPointerObservable.add(m=>{if(m.type===H.POINTERMOVE&&S.current==="place"&&te(e),m.type===H.POINTERDOWN&&d.current&&d.current.isVisible&&S.current==="place"){ie();return}}),ae(e),_(),B)try{V(B)}catch(m){console.error("Error loading initial scene data:",m)}return r.runRenderLoop(()=>{e.render()}),window.addEventListener("resize",()=>{r.resize()}),()=>{window.removeEventListener("resize",()=>{r.resize()}),k=null,r.dispose()}},[B]),u.useEffect(()=>{S.current=N},[N]);const ee=r=>{const e=g.CreateGround("grid",{width:b,height:b},r);e.position.x-=.5,e.position.y-=.5,e.position.z-=.5;const t=new Ne("gridMaterial",r);return t.majorUnitFrequency=5,t.minorUnitVisibility=.45,t.gridRatio=1,t.mainColor=new o(.6,.6,.6),t.lineColor=new o(.8,.8,.8),t.opacity=.98,e.material=t,e.receiveShadows=!0,e.position.y-=.01,K.current=e,e},re=r=>{const e=g.CreateBox("placementBox",{size:l},r),t=new x("placementBoxMaterial",r);return t.diffuseColor=new o(.2,.8,.2),t.alpha=.3,t.emissiveColor=new o(.1,.6,.1),t.wireframe=!1,e.material=t,e.isVisible=!1,d.current=e,e},te=(r,e)=>{if(!r||S.current!=="place"||!D.current)return;const t=r.pick(r.pointerX,r.pointerY);if(!t.hit){d.current&&(d.current.isVisible=!1);return}const n=t.pickedMesh,a=t.pickedPoint;if(n.name==="skybox"&&(d.current.isVisible=!1),n&&n.name==="positioningPlane"){const c=Math.floor(a.x/l+.5)*l,p=Math.floor(a.z/l+.5)*l;d.current&&(d.current.position=new y(c,0,p),d.current.isVisible=!0)}else if(n&&!["grid","positioningPlane","skybox","placementBox"].includes(n.name)){const c=t.getNormal(!0);if(c){const p=new y(Math.abs(c.x)>.5?Math.sign(c.x):0,Math.abs(c.y)>.5?Math.sign(c.y):0,Math.abs(c.z)>.5?Math.sign(c.z):0),m=n.position.clone().clone();m.x+=p.x*l,m.y+=p.y*l,m.z+=p.z*l;const C=Math.round(m.x/l)*l,z=Math.round(m.y/l)*l,he=Math.round(m.z/l)*l;if(d.current){d.current.position=new y(C,z,he),d.current.isVisible=!0;const j=d.current.material;p.y===1?(j.diffuseColor=new o(.2,.8,.2),j.emissiveColor=new o(.1,.6,.1)):p.y===-1?(j.diffuseColor=new o(.8,.2,.2),j.emissiveColor=new o(.6,.1,.1)):(j.diffuseColor=new o(.2,.2,.8),j.emissiveColor=new o(.1,.1,.6))}ne(n,c)}}},ne=(r,e)=>{h.current&&h.current.removeAllMeshes(),!(!e||!r||["grid","positioningPlane","skybox","placementBox"].includes(r.name))&&h.current.addMesh(r,new o(.3,.3,1),!1)},ie=()=>{if(!d.current||!d.current.isVisible)return;const r=d.current.position.clone();se(r.x,r.y,r.z),d.current.isVisible=!1},ae=r=>{const e=g.CreateBox("skybox",{size:1e3},r),t=new x("skyboxMaterial",r);return t.backFaceCulling=!1,t.diffuseColor=new o(0,0,0),t.specularColor=new o(0,0,0),t.emissiveColor=new o(.2,.5,.8),e.material=t,e},se=(r,e,t)=>{const n=D.current;if(!n){console.error("Ассет не выбран!"),f("Сначала выберите объект для размещения","error");return}if(!s.current){console.error("Сцена не инициализирована!");return}let a;try{switch(n){case"cube":a=g.CreateBox("cube_"+Date.now(),{size:l},s.current),a.material=new x("cubeMaterial",s.current),a.material.diffuseColor=new o(.4,.4,.8);break;case"sphere":a=g.CreateSphere("sphere_"+Date.now(),{diameter:l},s.current),a.material=new x("sphereMaterial",s.current),a.material.diffuseColor=new o(.8,.4,.4);break;case"cylinder":a=g.CreateCylinder("cylinder_"+Date.now(),{diameter:l,height:l},s.current),a.material=new x("cylinderMaterial",s.current),a.material.diffuseColor=new o(.4,.8,.4);break;case"player":const c=s.current.getMeshByName("player");c&&c.dispose(),a=g.CreateSphere("player",{diameter:.8},s.current);const p=new x("playerMaterial",s.current);p.diffuseColor=new o(0,0,1),a.material=p;const w=g.CreateCylinder("playerDirection",{diameter:.2,height:.5},s.current);w.parent=a,w.position.x=.4;const m=new x("directionMaterial",s.current);m.diffuseColor=new o(1,0,0),w.material=m;break;case"exit":const C=s.current.getMeshByName("exit");C&&C.dispose(),a=g.CreateBox("exit",{size:l},s.current);const z=new x("exitMaterial",s.current);z.diffuseColor=new o(0,1,0),z.alpha=.7,a.material=z;break;default:console.error(`Неизвестный тип ассета: ${n}`),f(`Неизвестный тип ассета: ${n}`,"error");return}return a.position=new y(r,e,t),a.metadata={type:n,isInteractable:n==="player"||n==="exit"},a.isPickable=!0,a.actionManager=new A(s.current),a.actionManager.registerAction(new X(A.OnPickTrigger,c=>{S.current!=="place"&&J(a)})),d.current&&(d.current.isVisible=!1),a}catch{return null}},J=r=>{if(S.current==="delete"){oe(r);return}v.current&&(v.current.material&&(v.current.material.emissiveColor=new o(0,0,0)),h.current&&h.current.removeMesh(v.current)),v.current=r,r&&r.material&&(r.material.emissiveColor=new o(.5,.5,.5),h.current&&h.current.addMesh(r,new o(1,.6,.1)))},oe=r=>{!r||r.name==="grid"||r.name==="positioningPlane"||r.name==="skybox"||(v.current===r&&(v.current=null),h.current&&h.current.removeMesh(r),r.dispose())},$=()=>{if(!s.current)return null;const r=[];return s.current.meshes.forEach(e=>{var n;if(e.name==="grid"||e.name==="positioningPlane"||e.name==="skybox"||e.name==="placementBox")return;const t={id:"map_"+e.name,type:((n=e.metadata)==null?void 0:n.type)||"unknown",metadata:e.metadata||{},transform:{position:{x:e.position.x,y:e.position.y,z:e.position.z},rotation:{x:e.rotation.x,y:e.rotation.y,z:e.rotation.z},scaling:{x:e.scaling.x,y:e.scaling.y,z:e.scaling.z}}};r.push(t)}),{version:"1.0",timestamp:Date.now(),models:r}},V=r=>{!s.current||!r||!r.models||(T(),r.gridSize&&r.gridSize,r.models.forEach(e=>{let t;switch(e.type){case"cube":t=g.CreateBox(e.id,{size:l},s.current);const n=new x("cubeMaterial",s.current);n.diffuseColor=new o(.4,.4,.8),t.material=n;break;case"sphere":t=g.CreateSphere(e.id,{diameter:l},s.current);const a=new x("sphereMaterial",s.current);a.diffuseColor=new o(.8,.4,.4),t.material=a;break;case"cylinder":t=g.CreateCylinder(e.id,{diameter:l,height:l},s.current);const c=new x("cylinderMaterial",s.current);c.diffuseColor=new o(.4,.8,.4),t.material=c;break;case"player":t=g.CreateSphere(e.id,{diameter:.8},s.current);const p=new x("playerMaterial",s.current);p.diffuseColor=new o(0,0,1),t.material=p;const w=g.CreateCylinder("playerDirection",{diameter:.2,height:.5},s.current);w.parent=t,w.position.x=.4;const m=new x("directionMaterial",s.current);m.diffuseColor=new o(1,0,0),w.material=m;break;case"exit":t=g.CreateBox(e.id,{size:l},s.current);const C=new x("exitMaterial",s.current);C.diffuseColor=new o(0,1,0),C.alpha=.7,t.material=C;break;default:console.warn(`Неизвестный тип объекта: ${e.type}`);return}e.transform.position&&(t.position=new y(e.transform.position.x,e.transform.position.y,e.transform.position.z)),e.transform.rotation&&(t.rotation=new y(e.transform.rotation.x,e.transform.rotation.y,e.transform.rotation.z)),e.transform.scaling&&(t.scaling=new y(e.transform.scaling.x,e.transform.scaling.y,e.transform.scaling.z)),t.metadata=e.metadata,t.isPickable=!0,t.actionManager=new A(s.current),t.actionManager.registerAction(new X(A.OnPickTrigger,n=>{J(t)}))}),f("Уровень успешно загружен","success"))},T=()=>{if(!s.current)return;s.current.meshes.filter(e=>e.name!=="grid"&&e.name!=="positioningPlane"&&e.name!=="skybox"&&e.name!=="placementBox").forEach(e=>{e.dispose()}),v.current=null,h.current&&h.current.removeAllMeshes(),d.current&&(d.current.isVisible=!1)},ce=()=>{if(!M){f("Укажите имя уровня для сохранения","error");return}try{const r=$();if(!r){f("Ошибка сериализации сцены","error");return}const e=R+M;localStorage.setItem(e,JSON.stringify(r)),f(`Уровень "${M}" успешно сохранен`,"success"),_()}catch(r){console.error("Ошибка сохранения уровня:",r),f("Не удалось сохранить уровень","error")}},_=()=>{var e;const r=[];for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t);if(n.startsWith(R))try{const a=JSON.parse(localStorage.getItem(n)),c=n.substring(R.length);r.push({name:c,timestamp:a.timestamp||0,objectCount:((e=a.objects)==null?void 0:e.length)||0})}catch(a){console.warn(`Ошибка при загрузке данных уровня ${n}:`,a)}}r.sort((t,n)=>n.timestamp-t.timestamp),q(r)},le=r=>{try{const e=R+r,t=localStorage.getItem(e);if(!t){f(`Уровень "${r}" не найден`,"error");return}const n=JSON.parse(t);V(n),L(r)}catch(e){console.error("Ошибка загрузки уровня:",e),f("Не удалось загрузить уровень","error")}},de=r=>{if(window.confirm(`Вы действительно хотите удалить уровень "${r}"?`))try{const e=R+r;localStorage.removeItem(e),f(`Уровень "${r}" удален`,"info"),_(),M===r&&L("")}catch(e){console.error("Ошибка удаления уровня:",e),f("Не удалось удалить уровень","error")}},ue=()=>{try{const r=$();if(!r){f("Ошибка сериализации сцены","error");return}const e=(M||"level")+".json",t="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(r,null,2)),n=document.createElement("a");n.setAttribute("href",t),n.setAttribute("download",e),document.body.appendChild(n),n.click(),n.remove(),f(`Уровень экспортирован в файл ${e}`,"success")}catch(r){console.error("Ошибка экспорта уровня:",r),f("Не удалось экспортировать уровень","error")}},fe=r=>{const e=r.target.files[0];if(!e)return;const t=new FileReader;t.onload=n=>{try{const a=JSON.parse(n.target.result);V(a);const c=e.name.replace(/\.[^/.]+$/,"");L(c),f(`Уровень успешно импортирован из файла ${e.name}`,"success")}catch(a){console.error("Ошибка импорта уровня:",a),f("Не удалось импортировать уровень. Проверьте формат файла","error")}},t.readAsText(e),r.target.value=null},me=()=>i.jsxs("div",{className:"bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-3 shadow-sm mb-2 flex flex-wrap items-center",children:[i.jsxs("div",{className:"flex items-center gap-2 flex-grow sm:flex-grow-0",children:[i.jsx("button",{className:`px-3 py-1.5 rounded-md ${N==="place"?"bg-blue-600 text-white":"bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-white"}`,onClick:()=>I("place")&console.log(N),children:"Размещение"}),i.jsx("button",{className:`px-3 py-1.5 rounded-md ${N==="delete"?"bg-red-600 text-white":"bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-white"}`,onClick:()=>I("delete")&console.log(N),children:"Удаление"})]}),i.jsx("div",{className:"ml-auto",children:i.jsx("button",{className:"px-4 py-1.5 rounded-md bg-red-600 text-white w-full sm:w-auto min-w-[150px] flex items-center justify-center",onClick:()=>{window.confirm("Вы действительно хотите очистить сцену?")&&T()},children:i.jsx("span",{children:"Очистить сцену"})})})]}),ge=()=>{var e;const r=t=>{Z(t),D.current=t,I("place"),f(`Выбран объект: ${t}. Наведите на сетку или объект, чтобы увидеть позицию размещения.`,"info")};return i.jsxs("div",{className:"w-full md:w-64 h-64 md:h-auto overflow-y-auto bg-gray-100 dark:bg-gray-800 p-2 rounded",children:[i.jsx("h3",{className:"text-lg font-bold mb-2 text-gray-800 dark:text-white",children:"Ассеты"}),i.jsx("div",{className:"text-yellow-600 dark:text-yellow-300 text-sm mb-3",children:"Выберите объект для размещения:"}),i.jsx("div",{className:"grid grid-cols-2 md:grid-cols-1 gap-2",children:F.map(t=>i.jsxs("button",{className:`p-2 text-left rounded flex items-center
                ${P===t.id?"bg-blue-600 border-2 border-white dark:border-white text-white":"bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-white"}`,onClick:()=>r(t.id),children:[i.jsx("div",{className:"w-6 h-6 mr-2 flex-shrink-0 bg-blue-800 rounded flex items-center justify-center text-white",children:t.id.charAt(0).toUpperCase()}),i.jsx("span",{children:t.name})]},t.id))}),i.jsxs("div",{className:"mt-4 p-2 bg-gray-200 dark:bg-gray-700 rounded text-gray-800 dark:text-white",children:[i.jsx("strong",{children:"Текущий выбор:"})," ",P?((e=F.find(t=>t.id===P))==null?void 0:e.name)||P:"Не выбран"]})]})},pe=()=>i.jsxs("div",{className:"w-full md:w-64 bg-gray-100 dark:bg-gray-800 p-2 rounded",children:[i.jsx("h3",{className:"text-lg font-bold mb-2 text-gray-800 dark:text-white",children:"Сохранение и загрузка"}),i.jsxs("div",{className:"mb-4",children:[i.jsxs("div",{className:"gap-2 flex flex-col mb-2",children:[i.jsx("input",{type:"text",className:"flex-1 px-2 py-1 bg-white dark:bg-gray-700 text-center rounded text-gray-800 dark:text-white",placeholder:"Имя уровня",value:M,onChange:r=>L(r.target.value)}),i.jsx("button",{className:"px-3 py-1 bg-green-600 rounded text-white",onClick:ce,children:"Сохранить"})]}),i.jsxs("div",{className:"flex gap-2",children:[i.jsx("button",{className:"flex-1 px-3 py-1 bg-blue-600 rounded text-white",onClick:ue,children:"Экспорт"}),i.jsxs("label",{className:"flex-1",children:[i.jsx("input",{type:"file",accept:".json",className:"hidden",onChange:fe}),i.jsx("span",{className:"block px-3 py-1 bg-blue-600 rounded text-center cursor-pointer text-white",children:"Импорт"})]})]})]}),i.jsx("h4",{className:"font-bold mb-1 text-gray-800 dark:text-white",children:"Сохраненные уровни:"}),G.length===0?i.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm",children:"Нет сохраненных уровней"}):i.jsx("div",{className:"max-h-40 overflow-y-auto",children:G.map(r=>i.jsxs("div",{className:"flex items-center mb-1",children:[i.jsxs("button",{className:"flex-1 text-left px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded-l hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-white",onClick:()=>le(r.name),children:[r.name,i.jsxs("span",{className:"block text-xs text-gray-500 dark:text-gray-400",children:[new Date(r.timestamp).toLocaleDateString()," · ",r.objectCount," об."]})]}),i.jsx("button",{className:"px-2 py-1 bg-red-600 rounded-r hover:bg-red-700 text-white",onClick:()=>de(r.name),children:"X"})]},r.name))})]}),xe=()=>{if(!O)return null;const r={info:"bg-blue-600",success:"bg-green-600",error:"bg-red-600",warning:"bg-yellow-600"}[O.type]||"bg-blue-600";return i.jsx("div",{className:`fixed top-4 right-4 px-4 py-2 rounded shadow-lg ${r}`,children:O.message})};return i.jsxs("div",{className:"flex flex-col w-full h-screen overflow-hidden bg-white dark:bg-gray-900",children:[me(),i.jsxs("div",{className:"flex flex-col md:flex-row flex-1 gap-2 overflow-hidden px-3 pb-3",children:[i.jsxs("div",{className:"md:flex md:flex-col md:w-64 gap-2 overflow-y-auto",children:[ge(),pe()]}),i.jsx("div",{className:"flex-1 bg-gray-200 dark:bg-gray-900 rounded overflow-hidden relative",children:i.jsx("canvas",{ref:E,className:"w-full h-full"})})]}),xe()]})}W.exportScene=()=>k&&k.scene?k.serializeScene():null;W.clearScene=()=>{k&&k.clearScene&&k.clearScene()};export{W as E};
